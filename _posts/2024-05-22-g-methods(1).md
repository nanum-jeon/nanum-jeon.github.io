---
title: Replications for introduction to g-methods - g-formual (part 1)
output:
  md_document:
    variant: gfm+footnotes
    preserve_yaml: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../_posts") })
date: 2024-05-22
permalink: /posts/2024/05/g-methods1
excerpt: In this tutorial, we will focus on replicating the results using **g-formula** to esitmate the average causal effects of always taking treatment and compared to never-taking treatment. 
always_allow_html: true
toc: true
header:
  og_image: "posts/g-methods/time_chart.png"
tags:
  - tutorial
  - causality
---
This tutorial series aims to replicate g-methods explained in [this paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6074945/) by Naimi, A. I., Cole, S. R., and Kennedy, E. H (2017)[^1] using **R**. Originally, the paper used SAS to demonstrate g-methods. 

In this tutorial, we will focus on replicating the results using **g-formula** to esitmate the average causal effects of always taking treatment and compared to never-taking treatment. We will pay more attention to computation rather than proofs to perform replciations.  


<style>
  .toggle-content {
    display: none; /* Hides the content by default */
    padding-top: 20px; /* Top padding when content is shown */
  }
</style>

<script type="text/javascript">
  function toggle_visibility(event, id) {
    event.preventDefault();
    var element = document.getElementById(id);
    if (element.style.display === 'none' || element.style.display === '') {
      element.style.display = 'block'; 
      if (MathJax) {
        MathJax.typesetPromise([element]).catch(function (error) {
          console.error('Error typesetting MathJax', error);
        });
      }
    } else {
      element.style.display = 'none'; 
    }
  }
</script>


<a href="#" onclick="toggle_visibility(event, 'setting');">[Settings in the Paper]</a>
<div id = "setting" class="toggle-content"> 
  
The empirical setting is to treat HIV with a therapy regimen ($$A$$) in two time periods ($$t = 0, t = 1$$). Additionally, we measure the time-varying confounder, HIV viral load ($$Z$$) at times $$t = 0$$ and $$t = 1$$. Note that this time-varying confounder is measured prior to the treatment administered at each time period. Also, we assume $$Z$$ at time 0 is 1 (high, bad health condition) for all subjects. Our outcome is the CD4 count (cells/mm$$^3$$) observed at $$t = 2$$. 

Thus, we have:  

<img src="/images/posts/g-methods/time_chart.png" style="display: block; margin: auto; width: 80%;" />

Under the identifying assumptions described in <a href="[https://onlinelibrary.wiley.com/doi/full/10.1111/jssr.12826](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6074945/)">the paper</a>, we will estimate the average casual effect of always taking treatment ($$a_0 = 1, a_1 = 1$$), compared to never taking treatment ($$a_0 = 0, a_1 = 0$$) in both time periods. For notation, we are using subscripts to indicate time periods.
.</div>

  
## G-formula

The g-formula can be used to estimate the average potential outcome level that would be observed in the population (that is, marginal outcome[^2]) under a hypotetical treatment intervention. We esitmate the marginal mean of Y that would be observed if $$A_0$$ $$A_1$$ were set to some values $$a_0$$ and $$a_1$$ hypothetically using the estimator on the right hand side of the quesiton below.  

$$ \begin{align*} 
E(Y^{a_0, a_1}) =  \textstyle\sum_{a_1, z_1, a_0} \,\,\,&E(Y | A_1 = a_1, Z_1 = z_1, A_0 = a_0)\\\
&P(A_1 = a_1 | Z_1 = z_1, A_0 = a_0)\\\
&P(Z_1 = z_1 | A_0 = a_0)\\\
&P(A_0 = a_0)
\end{align*} 
$$ 

Because we hypothetically intervene on treatment, we are able to simplify our estimator. This simplification is possible because, as we intervene on treatment, the probability density for treatment becomes irrelevant; it is already determined at the point of our intervention.

$$E(Y^{a_0, a_1}) =  \textstyle\sum_{z_1} E(Y | A_1 = a_1, Z_1 = z_1, A_0 = a_0) P(Z_1 = z_1 | A_0 = a_0)$$

Thus, in our scenario, among those who are not treated at time 0 ($$A_0 = 0$$): $$N_{A_0 = 0} = $$

$$E[Y^{0, 0}] = E[Y | Z_1 = 1] \text{weight}_{Z_1 = 1} +  E[Y | Z_1 = 0] \text{weight}_{Z_1 = 0} $$  

Note that $$\text{weight}_{Z_1 = 1}$$ is the proportion of people among those who are not treated 

[^1]: Naimi, A. I., Cole, S. R., & Kennedy, E. H. (2017). An introduction to g methods. International journal of epidemiology, 46(2), 756-762.
[^2]: My two cents: the term <em>marginal</em> in plain English usually means <ins>of less importance</ins>. But in our context, the term <em>marginal</em> is used to indicate <ins>population</ins> level outcome in contrast to <ins>individual</ins> level outcome. In some sense, it might make sense, because it would be the best if we are able to estimate <ins>individual</ins> treatment effects. As it is often not very feasible, we instead rely on <ins>population</ins> level estimates, which could be <ins>less important</ins> in some sense. However, considering that the population encompasses all individuals, it can sometimes be puzzling why we refer to it as <ins>marginal.<ins>


