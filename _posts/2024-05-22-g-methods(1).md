---
title: "Replications for introduction to g-methods: g-formula (part 1)"
output:
  md_document:
    variant: gfm+footnotes
    preserve_yaml: TRUE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../_posts") })
date: 2024-05-22
permalink: /posts/2024/05/g-methods1
excerpt: In this tutorial, we will focus on replicating the results using **g-formula** to estimate the average causal effects of always taking treatment and compared to never-taking treatment. 
always_allow_html: true
toc: true
header:
  og_image: "posts/g-methods/time_chart.png"
tags:
  - tutorial
  - causality
---
This tutorial series aims to replicate g-methods explained in [this paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6074945/) by Naimi, A. I., Cole, S. R., and Kennedy, E. H (2017)[^1] using **R**. Originally, the paper used SAS to demonstrate g-methods. 

In this tutorial, we will focus on replicating the results using **g-formula** to esitmate the average causal effects of always taking treatment and compared to never-taking treatment. We will pay more attention to computation rather than proofs to perform replciations.  

<style>
  .toggle-content {
    display: none; /* Hides the content by default */
    padding-top: 20px; /* Top padding when content is shown */
  }
</style>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

<script>
  MathJax = {
    tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
    chtml: {
      displayAlign: 'left'
    },
    startup: {
      pageReady: function () {
        //
        //  Do the usual startup (which does a typeset).
        //  When that is all done, un-hide the page.
        //
        return MathJax.startup.defaultPageReady().then(function () {
          document.getElementById("hidden").disabled = true;
        });
      }
    }
  };
  </script>
<script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


<details>
<summary>Click to expand!</summary>

<div style="padding-top: 20px;">
Here you can include any markdown content which will be hidden until the summary part is clicked $A = 12$.

For example, explanation of the method, code snippets, or additional resources.
</div>

</details>





<script type="text/javascript">
  function toggle_visibility(event, id) {
    event.preventDefault();
    var element = document.getElementById(id);
    if (element.style.display === 'none' || element.style.display === '') {
      element.style.display = 'block'; 
    } else {
      element.style.display = 'none'; 
    }
  }
</script>


<a href="#" onclick="toggle_visibility(event, 'myElement')">Toggle</a>
<div id="myElement" style="display:none;">
    <p> The empirical setting is to treat HIV with a therapy regimen  $e^{i\pi} + 1 = 0$</p>
</div>

<a href="#" onclick="toggle_visibility(event, 'setting');">[Settings in the Paper]</a>
<div id = "setting" class="toggle-content"> 
  
<p>The empirical setting is to treat HIV with a therapy regimen ($A$) in two time periods ($t = 0, t = 1$). Additionally, we measure the time-varying confounder, HIV viral load ($$Z$$) at times $$t = 0$$ and $$t = 1$$. Note that this time-varying confounder is measured prior to the treatment administered at each time period. Also, we assume $$Z$$ at time 0 is 1 (high, bad health condition) for all subjects. Our outcome is the CD4 count (cells/mm$$^3$$) observed at $$t = 2$$.</p>

<p>Thus, we have:</p>

<img src="/images/posts/g-methods/time_chart.png" style="display: block; margin: auto; width: 80%;">

<p>Under the identifying assumptions described in <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6074945/">the paper</a>, we will estimate the average causal effect of always taking treatment ($$a_0 = 1, a_1 = 1$$), compared to never taking treatment ($$a_0 = 0, a_1 = 0$$) in both time periods. For notation, we are using subscripts to indicate time periods.</p>

</div>

  
## G-formula with computation 

The g-formula can be used to estimate the average potential outcome level that would be observed in the population (that is, marginal outcome[^2]) under a hypotetical treatment intervention. We esitmate the marginal mean of Y that would be observed if $$A_0$$ $$A_1$$ were set to some values $$a_0$$ and $$a_1$$ hypothetically using the estimator on the right hand side of the quesiton below.  

$$ \begin{align*} 
E(Y^{a_0, a_1}) =  \textstyle\sum_{a_1, z_1, a_0} \,\,\,&E(Y | A_1 = a_1, Z_1 = z_1, A_0 = a_0)\\\
&P(A_1 = a_1 | Z_1 = z_1, A_0 = a_0)\\\
&P(Z_1 = z_1 | A_0 = a_0)\\\
&P(A_0 = a_0)
\end{align*} 
$$ 

Because we hypothetically intervene on treatment, we are able to simplify our estimator. This simplification is possible because, as we intervene on treatment, the probability density for treatment becomes irrelevant; it is already determined at the point of our intervention.

$$
\begin{align*}
E(Y^{a_0, a_1}) =  \textstyle\sum_{z_1} \,\,\,&E(Y | A_1 = a_1, Z_1 = z_1, A_0 = a_0)\\\ 
&P(Z_1 = z_1 | A_0 = a_0) 
\end{align*}
$$

Note the right side of equation is essentially to compute weighted average of $$Y$$ marginalized by $$Z_1$$ given $$A_0$$.  

In our scenario, we compute two expected values to esitmate our estimand: average causal effects of always being treated compared to being never treatd. Thus, we are interested in computing two expected values for always treated intervention $$E[Y^{a_0 = 1, a_1 = 1}]$$ andfor never treated intervention  $$E[Y^{a_0 = 0, a_1 = 0}]$$. Finally, our estimand of interest ($$\hat{\tau}$$) is thus: $$ E[Y^{a_0 = 1, a_1 = 1}] - E[Y^{a_0 = 0, a_1 = 0}]$$

R-codes below demonstrate how we compute these values step-by-step. 

## Always treated internvetion 

```r
# E[Y^{1, 1}]

# The total number subjects in the A0 = 1 stratum 
a0_1_n <- data %>% 
  filter(a0 == 1) %>% 
  summarise(a0_1_n = sum(n)) %>% 
  pull()

#  Weights for Z1 = 0 and Z1 = 1 among those with A0 = 1 
weight <- data %>% 
  filter(a0 == 1) %>% 
  group_by(z1) %>% 
  summarise(weight = sum(n) / a0_1_n) %>% 
  select(z1, weight)

# Compute expectation’s value for always treated
expected_value_always_treated <- data %>% 
  filter(a0 == 1 & a1 == 1) %>% 
  left_join(weight, by = "z1") %>% 
  mutate(weighted_y = y * weight) %>% 
  group_by(a0, a1) %>% 
  summarise(weighted_sum = sum(weighted_y)) 

expected_value_always_treated
```

## Never treated internvetion 
```r
# E[Y^{0, 0}]
# Never treated 

# The total number subjects in the A0 = 0 stratum 
a0_0_n <- data %>% 
  filter(a0 == 0) %>% 
  summarise(a0_0_n = sum(n)) %>% 
  pull()

# Weights for Z1 = 0 and Z1 = 1 among those with A0 = 0 
weight <- data %>% 
  filter(a0 == 0) %>% 
  group_by(z1) %>% 
  summarise(weight = sum(n) / a0_0_n) %>% 
  select(z1, weight)

# Compute expectation’s value for those never treated 
expected_value_never_treated <- data %>% 
  filter(a0 == 0 & a1 == 0) %>% 
  left_join(weight, by = "z1") %>% 
  mutate(weighted_y = y * weight) %>% 
  group_by(a0, a1) %>% 
  summarise(weighted_sum = sum(weighted_y)) 

expected_value_never_treated
```

Finally, we report the results in Table below. We find that the average causal effect ($$\hat{\tau}$$)is $$50 = 150-500$$ as shown by the authors. 

| a0| a1| weighted_sum|
|--:|--:|------------:|
|  1|  1|     150.0621|
|  0|  0|     100.0370|


This approach to computing the value of the **g-formula** is called *nonparametric maximum likelihood estimation*. 

  
## G-formula with parametric models  

However, we often use simulation from parametric regression modles to construct a **g-formula** estimator. This approach is often the most realistic one having many covariates in our data. Now, we turn to how to use parametric regression models to use g-formula. 




[^1]: Naimi, A. I., Cole, S. R., & Kennedy, E. H. (2017). An introduction to g methods. International journal of epidemiology, 46(2), 756-762.
[^2]: My two cents: the term <em>marginal</em> in plain English usually means <ins>of less importance</ins>. But in our context, the term <em>marginal</em> is used to indicate <ins>population</ins> level outcome in contrast to <ins>individual</ins> level outcome. In some sense, it might make sense, because it would be the best if we are able to estimate <ins>individual</ins> treatment effects. As it is often not very feasible, we instead rely on <ins>population</ins> level estimates, which could be <ins>less important</ins> in some sense. However, considering that the population encompasses all individuals, it can sometimes be puzzling why we refer to it as <ins>marginal.<ins>


